<!DOCTYPE html>
<html lang="fa">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AR 3D Perfect Fix</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      #loading-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #000; z-index: 9999;
        display: flex; justify-content: center; align-items: center; color: white;
        font-family: sans-serif;
      }
      .hidden { display: none !important; }
      #debug {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px;
        font-size: 12px;
        z-index: 1000;
        display: none;
      }
    </style>
  </head>
  <body>
    
    <div id="loading-screen">
      <div>در حال تنظیم دقیق مدل...</div>
    </div>

    <div id="debug"></div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="avatarModel" src="./model.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      
      <a-light type="ambient" intensity="1"></a-light>
      <a-light type="directional" position="5 10 7" intensity="1"></a-light>

      <a-entity mindar-image-target="targetIndex: 0">
        
        <!-- انیمیشن چرخش -->
        <a-entity id="rotating-container" animation="property: rotation; to: 0 360 0; dur: 8000; easing: linear; loop: true">
          
          <!-- لایه تصحیح orientation - اینجا rotation اعمال میشه -->
          <a-entity id="orientation-fix">
            
            <!-- مدل اصلی -->
            <a-gltf-model 
              src="#avatarModel" 
              position="0 0 0" 
              scale="0.1 0.1 0.1"
              rotation="0 0 0"> 
            </a-gltf-model>

          </a-entity>
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      const orientationFix = document.getElementById('orientation-fix');
      const debugDiv = document.getElementById('debug');
      let baseOrientation = null;
      let currentCompensation = 0;

      // تابع برای گرفتن orientation فعلی
      function getCurrentOrientation() {
        if (window.screen && window.screen.orientation) {
          return window.screen.orientation.angle || 0;
        } else if (window.orientation !== undefined) {
          return window.orientation;
        }
        return 0;
      }

      // تابع برای محاسبه و اعمال compensation
      function updateOrientationCompensation() {
        const angle = getCurrentOrientation();
        
        // محاسبه compensation: معکوس زاویه گوشی
        let compensationZ = 0;
        
        switch(angle) {
          case 0:    // Portrait
            compensationZ = 0;
            break;
          case 90:   // Landscape راست
          case -270:
            compensationZ = -90;
            break;
          case -90:  // Landscape چپ
          case 270:
            compensationZ = 90;
            break;
          case 180:  // Portrait معکوس
          case -180:
            compensationZ = 180;
            break;
        }

        currentCompensation = compensationZ;
        
        // اعمال rotation
        if (orientationFix) {
          orientationFix.setAttribute('rotation', `0 0 ${compensationZ}`);
        }

        // دیباگ
        debugDiv.innerHTML = `
          Screen Angle: ${angle}°<br>
          Compensation: ${compensationZ}°<br>
          Type: ${getOrientationType()}
        `;
        
        console.log(`Screen: ${angle}° → Compensation: ${compensationZ}°`);
      }

      function getOrientationType() {
        const angle = getCurrentOrientation();
        if (angle === 0) return 'Portrait';
        if (angle === 90 || angle === -270) return 'Landscape Right';
        if (angle === -90 || angle === 270) return 'Landscape Left';
        if (angle === 180 || angle === -180) return 'Portrait Upside';
        return 'Unknown';
      }

      // Event listeners برای تغییرات orientation
      window.addEventListener('orientationchange', () => {
        setTimeout(updateOrientationCompensation, 100);
      });

      window.addEventListener('resize', () => {
        updateOrientationCompensation();
      });

      // اجرای اولیه
      setTimeout(() => {
        updateOrientationCompensation();
      }, 500);

      // حذف لودینگ
      const scene = document.querySelector('a-scene');
      const loadingScreen = document.getElementById('loading-screen');
      
      scene.addEventListener('loaded', () => { 
        setTimeout(() => { 
          loadingScreen.classList.add('hidden');
          updateOrientationCompensation();
        }, 1000); 
      });

      // فعال‌سازی دیباگ با دابل کلیک
      document.addEventListener('dblclick', () => {
        debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
      });
    </script>
  </body>
</html>

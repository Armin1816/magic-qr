<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ù†Ù…Ø§ÛŒØ´Ú¯Ø± Ù…Ø¯Ù„ Ø³Ù‡â€ŒØ¨Ø¹Ø¯ÛŒ AR</title>
    
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ AR -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        /* ØµÙØ­Ù‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯ */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            transition: opacity 0.5s;
        }
        
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            text-align: center;
            padding: 0 20px;
        }
        
        .progress-bar {
            width: 80%;
            max-width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.3s;
            border-radius: 3px;
        }
        
        /* Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ */
        #instruction {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
            text-align: center;
            max-width: 80%;
            backdrop-filter: blur(10px);
        }
        
        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ */
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        /* Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ */
        #error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 53, 69, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            display: none;
            z-index: 10000;
            text-align: center;
            max-width: 80%;
        }
    </style>
</head>
<body>
    <!-- ØµÙØ­Ù‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯ -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <div class="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
    </div>
    
    <!-- Ù¾ÛŒØ§Ù… Ø±Ø§Ù‡Ù†Ù…Ø§ -->
    <div id="instruction">ğŸ“± Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø§ Ø¨Ù‡ Ø³Ù…Øª ØªØµÙˆÛŒØ± Ù‡Ø¯Ù Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯</div>
    
    <!-- Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ -->
    <div id="error-message"></div>
    
    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ -->
    <div class="controls">
        <button class="control-btn" id="reset-btn" title="Ø±ÛŒØ³Øª">ğŸ”„</button>
        <button class="control-btn" id="info-btn" title="Ø±Ø§Ù‡Ù†Ù…Ø§">â„¹ï¸</button>
    </div>
    
    <!-- ØµØ­Ù†Ù‡ AR -->
    <a-scene
        mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.01; warmupTolerance: 5; missTolerance: 5"
        color-space="sRGB"
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; alpha: true"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        embedded
        gesture-detector
        id="scene">
        
        <!-- Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§ -->
        <a-assets timeout="30000">
            <a-asset-item id="avatarModel" src="./model.glb"></a-asset-item>
        </a-assets>
        
        <!-- Ù†ÙˆØ±Ù¾Ø±Ø¯Ø§Ø²ÛŒ Ø¨Ù‡ØªØ± -->
        <a-light type="ambient" intensity="0.8"></a-light>
        <a-light type="directional" intensity="0.5" position="1 1 1"></a-light>
        <a-light type="hemisphere" intensity="0.3"></a-light>
        
        <!-- Ø¯ÙˆØ±Ø¨ÛŒÙ† -->
        <a-camera position="0 0 0" look-controls="enabled: false" cursor="rayOrigin: mouse"></a-camera>
        
        <!-- Ù‡Ø¯Ù ØªØµÙˆÛŒØ±ÛŒ -->
        <a-entity mindar-image-target="targetIndex: 0">
            <!-- Ù…Ø¯Ù„ Ø³Ù‡â€ŒØ¨Ø¹Ø¯ÛŒ Ø¨Ø§ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† -->
            <a-gltf-model 
                id="model"
                rotation="0 0 0" 
                position="0 0 0" 
                scale="0.5 0.5 0.5" 
                src="#avatarModel"
                animation="property: rotation; to: 0 360 0; dur: 10000; easing: linear; loop: true"
                animation__scale="property: scale; to: 0.55 0.55 0.55; dur: 2000; dir: alternate; loop: true; easing: easeInOutSine"
                class="clickable"
                gesture-handler>
            </a-gltf-model>
            
            <!-- Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ -->
            <a-ring
                position="0 -0.1 0"
                rotation="-90 0 0"
                radius-inner="0.3"
                radius-outer="0.5"
                color="#667eea"
                opacity="0.3"
                animation="property: scale; to: 1.2 1.2 1.2; dur: 1500; dir: alternate; loop: true">
            </a-ring>
        </a-entity>
    </a-scene>
    
    <script>
        // Ù…Ø¯ÛŒØ±ÛŒØª Ù„ÙˆØ¯ÛŒÙ†Ú¯
        let loadingProgress = 0;
        const progressBar = document.getElementById('progress');
        const loadingScreen = document.getElementById('loading-screen');
        const instruction = document.getElementById('instruction');
        const errorMessage = document.getElementById('error-message');
        const scene = document.getElementById('scene');
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÚ¯Ø±Ø³ Ø¨Ø§Ø±
        function updateProgress(percent) {
            loadingProgress = Math.min(percent, 100);
            progressBar.style.width = loadingProgress + '%';
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
        function showError(message) {
            errorMessage.textContent = 'âŒ ' + message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        
        // Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
        let assetsLoaded = false;
        let arSystemReady = false;
        
        // Ø´Ù†ÙˆØ¯ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§
        AFRAME.registerComponent('asset-loader', {
            init: function() {
                const assets = document.querySelector('a-assets');
                if (assets) {
                    updateProgress(30);
                    
                    assets.addEventListener('loaded', () => {
                        console.log('Assets loaded');
                        assetsLoaded = true;
                        updateProgress(60);
                        checkAllLoaded();
                    });
                    
                    assets.addEventListener('error', (e) => {
                        console.error('Asset loading error:', e);
                        showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.');
                        updateProgress(0);
                    });
                }
            }
        });
        
        // Ø«Ø¨Øª Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øª
        scene.setAttribute('asset-loader', '');
        
        // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… AR
        scene.addEventListener('renderstart', () => {
            console.log('AR System Ready');
            arSystemReady = true;
            updateProgress(90);
            checkAllLoaded();
        });
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø¨ÙˆØ¯Ù† Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
        function checkAllLoaded() {
            if (assetsLoaded && arSystemReady) {
                updateProgress(100);
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    instruction.style.display = 'block';
                }, 500);
            }
        }
        
        // Ø´Ø±ÙˆØ¹ Ù¾Ø±ÙˆÚ¯Ø±Ø³
        updateProgress(10);
        
        // ØªØ´Ø®ÛŒØµ Ù‡Ø¯Ù
        const arSystem = scene.systems['mindar-image-system'];
        scene.addEventListener('targetFound', event => {
            console.log('Target found');
            instruction.textContent = 'âœ… Ù‡Ø¯Ù ÛŒØ§ÙØª Ø´Ø¯! Ù…Ø¯Ù„ Ø¯Ø± Ø­Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø§Ø³Øª';
            instruction.style.background = 'rgba(40, 167, 69, 0.8)';
        });
        
        scene.addEventListener('targetLost', event => {
            console.log('Target lost');
            instruction.textContent = 'ğŸ“± Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø§ Ø¨Ù‡ Ø³Ù…Øª ØªØµÙˆÛŒØ± Ù‡Ø¯Ù Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯';
            instruction.style.background = 'rgba(0, 0, 0, 0.7)';
        });
        
        // Ø¯Ú©Ù…Ù‡ Ø±ÛŒØ³Øª
        document.getElementById('reset-btn').addEventListener('click', () => {
            location.reload();
        });
        
        // Ø¯Ú©Ù…Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§
        document.getElementById('info-btn').addEventListener('click', () => {
            alert('ğŸ“± Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡:\n\n1. Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø§ Ø¨Ù‡ Ø³Ù…Øª ØªØµÙˆÛŒØ± Ù‡Ø¯Ù Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯\n2. Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯ ØªØ§ Ù…Ø¯Ù„ Ø³Ù‡â€ŒØ¨Ø¹Ø¯ÛŒ Ø¸Ø§Ù‡Ø± Ø´ÙˆØ¯\n3. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ø§Ù†Ú¯Ø´Øª Ù…Ø¯Ù„ Ø±Ø§ Ø¨Ø²Ø±Ú¯/Ú©ÙˆÚ†Ú© Ú©Ù†ÛŒØ¯\n4. Ù…Ø¯Ù„ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ†Ø±Ø®Ø¯');
        });
        
        // Ù…Ø¯ÛŒØ±ÛŒØª Ú˜Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø²ÙˆÙ…
        AFRAME.registerComponent('gesture-handler', {
            schema: {
                enabled: { default: true },
                rotationFactor: { default: 5 },
                minScale: { default: 0.3 },
                maxScale: { default: 8 }
            },
            
            init: function() {
                this.handleScale = this.handleScale.bind(this);
                this.handleRotate = this.handleRotate.bind(this);
                
                this.isVisible = false;
                this.initialScale = this.el.object3D.scale.clone();
                this.scaleFactor = 1;
                
                this.el.sceneEl.addEventListener('targetFound', () => {
                    this.isVisible = true;
                });
                
                this.el.sceneEl.addEventListener('targetLost', () => {
                    this.isVisible = false;
                });
            },
            
            play: function() {
                window.addEventListener('touchmove', this.handleScale);
                window.addEventListener('touchmove', this.handleRotate);
            },
            
            pause: function() {
                window.removeEventListener('touchmove', this.handleScale);
                window.removeEventListener('touchmove', this.handleRotate);
            },
            
            handleRotate: function(event) {
                if (!this.isVisible || event.touches.length !== 1) return;
            },
            
            handleScale: function(event) {
                if (!this.isVisible || event.touches.length !== 2) return;
                
                event.preventDefault();
                
                const touch1 = event.touches[0];
                const touch2 = event.touches[1];
                
                const distance = Math.sqrt(
                    Math.pow(touch2.pageX - touch1.pageX, 2) +
                    Math.pow(touch2.pageY - touch1.pageY, 2)
                );
                
                if (this.previousDistance) {
                    const delta = distance - this.previousDistance;
                    this.scaleFactor += delta * 0.001;
                    this.scaleFactor = Math.max(
                        this.data.minScale,
                        Math.min(this.data.maxScale, this.scaleFactor)
                    );
                    
                    this.el.object3D.scale.x = this.initialScale.x * this.scaleFactor;
                    this.el.object3D.scale.y = this.initialScale.y * this.scaleFactor;
                    this.el.object3D.scale.z = this.initialScale.z * this.scaleFactor;
                }
                
                this.previousDistance = distance;
            }
        });
        
        // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø±ÙØ±Ø´ ØµÙØ­Ù‡ Ø¨Ø§ Ú©Ø´ÛŒØ¯Ù†
        document.addEventListener('touchmove', function(event) {
            if (event.scale !== 1) {
                event.preventDefault();
            }
        }, { passive: false });
        
        // Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ
        window.addEventListener('error', (e) => {
            console.error('Runtime error:', e);
            if (!assetsLoaded) {
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.');
            }
        });
        
        // ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª Ø§Ù…Ù†ÛŒØªÛŒ
        setTimeout(() => {
            if (!assetsLoaded || !arSystemReady) {
                console.warn('Loading timeout');
                showError('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯...');
                setTimeout(() => location.reload(), 3000);
            }
        }, 30000);
    </script>
</body>
</html>

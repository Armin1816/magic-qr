<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ŸÜŸÖÿß€åÿ¥⁄Øÿ± ŸÖÿØŸÑ ÿ≥Ÿá‚Äåÿ®ÿπÿØ€å AR</title>
    
    <!-- ⁄©ÿ™ÿßÿ®ÿÆÿßŸÜŸá‚ÄåŸáÿß€å AR -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
        }
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            transition: opacity 0.8s ease;
        }
        
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top: 5px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            padding: 0 20px;
            margin-bottom: 10px;
        }
        
        .loading-subtext {
            font-size: 14px;
            opacity: 0.8;
            text-align: center;
            padding: 0 20px;
            margin-bottom: 20px;
        }
        
        .progress-container {
            width: 85%;
            max-width: 350px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 4px;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fff, #e0e7ff);
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 16px;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-size: 16px;
            font-weight: 600;
        }
        
        #instruction {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            font-size: 15px;
            z-index: 1000;
            text-align: center;
            max-width: 85%;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            display: none;
        }
        
        #debug-info {
            position: fixed;
            bottom: 100px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            border-radius: 5px;
            z-index: 999;
            max-width: 90%;
            display: none;
        }
        
        .controls {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .controls.visible {
            opacity: 1;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .control-btn:active {
            transform: scale(0.9);
        }
        
        #error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 53, 69, 0.95);
            color: white;
            padding: 25px 35px;
            border-radius: 20px;
            display: none;
            z-index: 10000;
            text-align: center;
            max-width: 85%;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-title">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...</div>
        <div class="loading-subtext" id="loading-subtitle">ŸÑÿ∑ŸÅÿßŸã ÿµÿ®Ÿàÿ± ÿ®ÿßÿ¥€åÿØ</div>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
            <div class="progress-text" id="progress-text">0%</div>
        </div>
    </div>
    
    <div id="instruction">üì± ÿØŸàÿ±ÿ®€åŸÜ ÿ±ÿß ÿ®Ÿá ÿ≥ŸÖÿ™ ÿ™ÿµŸà€åÿ± ŸáÿØŸÅ ŸÜ⁄ØŸá ÿØÿßÿ±€åÿØ</div>
    <div id="error-message"></div>
    <div id="debug-info"></div>
    
    <div class="controls" id="controls">
        <button class="control-btn" id="toggle-debug">üêõ</button>
        <button class="control-btn" id="reset-btn">üîÑ</button>
        <button class="control-btn" id="info-btn">‚ÑπÔ∏è</button>
    </div>
    
    <a-scene
        mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.001; filterBeta: 0.1; warmupTolerance: 10; missTolerance: 10"
        color-space="sRGB"
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; alpha: true"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        embedded
        id="scene"
        loading-screen="enabled: false">
        
        <a-assets timeout="120000">
            <a-asset-item id="avatarModel" src="./model.glb"></a-asset-item>
        </a-assets>
        
        <!-- ŸÜŸàÿ±Ÿæÿ±ÿØÿßÿ≤€å ŸÇŸà€å‚Äåÿ™ÿ± -->
        <a-light type="ambient" intensity="1.5"></a-light>
        <a-light type="directional" intensity="1" position="1 1 1"></a-light>
        <a-light type="directional" intensity="0.5" position="-1 1 -1"></a-light>
        <a-light type="point" intensity="1" position="0 2 0"></a-light>
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <a-entity mindar-image-target="targetIndex: 0" id="target">
            
            <!-- ŸÖÿØŸÑ ÿßÿµŸÑ€å ÿ®ÿß scale ÿ®ÿ≤ÿ±⁄Øÿ™ÿ± -->
            <a-gltf-model 
                id="mainModel"
                rotation="0 0 0" 
                position="0 0 0" 
                scale="1 1 1"
                src="#avatarModel"
                animation="property: rotation; to: 0 360 0; dur: 8000; easing: linear; loop: true"
                visible="true">
            </a-gltf-model>
            
            <!-- ÿ¥⁄©ŸÑ ÿ™ÿ≥ÿ™ (ŸÖ⁄©ÿπÿ® ŸÇÿ±ŸÖÿ≤) - ÿ®ÿ±ÿß€å ÿßÿ∑ŸÖ€åŸÜÿßŸÜ ÿßÿ≤ ⁄©ÿßÿ±⁄©ÿ±ÿØ AR -->
            <a-box 
                id="testBox"
                position="0 0.5 0" 
                rotation="0 45 0" 
                scale="0.3 0.3 0.3"
                color="#ff0000"
                animation="property: rotation; to: 0 405 0; dur: 3000; easing: linear; loop: true"
                visible="true">
            </a-box>
            
            <!-- ÿ≠ŸÑŸÇŸá ŸÜŸàÿ±€å -->
            <a-ring
                position="0 0 0"
                rotation="-90 0 0"
                radius-inner="0.4"
                radius-outer="0.7"
                color="#667eea"
                opacity="0.6"
                animation="property: scale; to: 1.3 1.3 1.3; dur: 1500; dir: alternate; loop: true"
                visible="true">
            </a-ring>
            
            <!-- ŸÖÿ™ŸÜ ÿ™ÿ≥ÿ™ -->
            <a-text 
                value="AR Working!" 
                position="0 1 0" 
                align="center" 
                color="#00ff00"
                scale="2 2 2"
                visible="true">
            </a-text>
            
        </a-entity>
    </a-scene>
    
    <script>
        const loadingScreen = document.getElementById('loading-screen');
        const progressBar = document.getElementById('progress');
        const progressText = document.getElementById('progress-text');
        const loadingTitle = document.getElementById('loading-title');
        const loadingSubtitle = document.getElementById('loading-subtitle');
        const instruction = document.getElementById('instruction');
        const errorMessage = document.getElementById('error-message');
        const scene = document.getElementById('scene');
        const controls = document.getElementById('controls');
        const debugInfo = document.getElementById('debug-info');
        
        let debugMode = false;
        let debugLog = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            debugLog.push(logMessage);
            if (debugMode) {
                debugInfo.innerHTML = debugLog.slice(-10).join('<br>');
            }
        }
        
        function updateProgress(percent, status = '') {
            progressBar.style.width = percent + '%';
            progressText.textContent = Math.round(percent) + '%';
            if (status) loadingSubtitle.textContent = status;
            
            if (percent < 30) loadingTitle.textContent = '‚è≥ ÿØÿ± ÿ≠ÿßŸÑ ÿßÿ™ÿµÿßŸÑ...';
            else if (percent < 60) loadingTitle.textContent = 'üì¶ ÿØÿ± ÿ≠ÿßŸÑ ÿØÿßŸÜŸÑŸàÿØ...';
            else if (percent < 90) loadingTitle.textContent = 'üé® ÿØÿ± ÿ≠ÿßŸÑ Ÿæÿ±ÿØÿßÿ≤ÿ¥...';
            else loadingTitle.textContent = '‚úÖ ÿ¢ŸÖÿßÿØŸá ÿßÿ≥ÿ™!';
        }
        
        log('üöÄ App started');
        updateProgress(10);
        
        // ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å Assets
        const assets = document.querySelector('a-assets');
        const model = document.getElementById('mainModel');
        const testBox = document.getElementById('testBox');
        const target = document.getElementById('target');
        
        if (assets) {
            updateProgress(20, 'ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÖÿØŸÑ...');
            
            assets.addEventListener('loaded', () => {
                log('‚úÖ Assets loaded successfully');
                updateProgress(70);
                
                // ÿ®ÿ±ÿ±ÿ≥€å ŸÖÿØŸÑ
                if (model) {
                    model.addEventListener('model-loaded', () => {
                        log('‚úÖ GLB Model loaded!');
                        log(`Model scale: ${model.getAttribute('scale').x}`);
                        log(`Model position: ${JSON.stringify(model.getAttribute('position'))}`);
                    });
                    
                    model.addEventListener('model-error', (e) => {
                        log('‚ùå Model error: ' + e.detail);
                        errorMessage.textContent = '‚ö†Ô∏è ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÖÿØŸÑ GLB\nŸÖ⁄©ÿπÿ® ŸÇÿ±ŸÖÿ≤ ÿ®Ÿá ÿ¨ÿß€å ÿ¢ŸÜ ŸÜŸÖÿß€åÿ¥ ÿØÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ';
                        errorMessage.style.display = 'block';
                        setTimeout(() => errorMessage.style.display = 'none', 5000);
                    });
                }
            });
            
            assets.addEventListener('timeout', () => {
                log('‚ùå Assets timeout');
                errorMessage.textContent = '‚ö†Ô∏è ÿ≤ŸÖÿßŸÜ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ™ŸÖÿßŸÖ ÿ¥ÿØ\nÿßÿ≤ ŸÖ⁄©ÿπÿ® ÿ™ÿ≥ÿ™ ÿßÿ≥ÿ™ŸÅÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ';
                errorMessage.style.display = 'block';
            });
        }
        
        // ÿ¢ŸÖÿßÿØŸá‚Äåÿ≥ÿßÿ≤€å AR
        scene.addEventListener('loaded', () => {
            log('‚úÖ Scene loaded');
            updateProgress(85);
        });
        
        scene.addEventListener('renderstart', () => {
            log('‚úÖ AR System ready');
            updateProgress(100);
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                instruction.style.display = 'block';
                controls.classList.add('visible');
                log('üéâ App fully ready');
            }, 800);
        });
        
        // ÿ™ÿ¥ÿÆ€åÿµ ŸáÿØŸÅ
        let targetFound = false;
        
        scene.addEventListener('targetFound', (e) => {
            targetFound = true;
            log('üéØ TARGET FOUND!');
            instruction.textContent = '‚úÖ ŸáÿØŸÅ €åÿßŸÅÿ™ ÿ¥ÿØ! ÿ®ÿß€åÿØ ŸÖÿØŸÑ ÿ±ÿß ÿ®ÿ®€åŸÜ€åÿØ';
            instruction.style.background = 'rgba(40, 167, 69, 0.9)';
            
            // ÿßÿ∑ŸÖ€åŸÜÿßŸÜ ÿßÿ≤ ŸÜŸÖÿß€åÿ¥ ŸáŸÖŸá ⁄Ü€åÿ≤
            if (target) {
                log('Setting all objects visible');
                const entities = target.querySelectorAll('*');
                entities.forEach(entity => {
                    entity.setAttribute('visible', 'true');
                });
            }
            
            // ŸÑÿß⁄Ø ŸÖŸàŸÇÿπ€åÿ™‚ÄåŸáÿß
            setTimeout(() => {
                if (model) {
                    const scale = model.getAttribute('scale');
                    const position = model.getAttribute('position');
                    log(`Model visible: ${model.getAttribute('visible')}`);
                    log(`Model scale: ${scale.x}, ${scale.y}, ${scale.z}`);
                    log(`Model position: ${position.x}, ${position.y}, ${position.z}`);
                }
                if (testBox) {
                    log(`TestBox visible: ${testBox.getAttribute('visible')}`);
                }
            }, 1000);
        });
        
        scene.addEventListener('targetLost', () => {
            targetFound = false;
            log('‚ùå Target lost');
            instruction.textContent = 'üì± ÿØŸàÿ±ÿ®€åŸÜ ÿ±ÿß ÿ®Ÿá ÿ≥ŸÖÿ™ ÿ™ÿµŸà€åÿ± ŸáÿØŸÅ ŸÜ⁄ØŸá ÿØÿßÿ±€åÿØ';
            instruction.style.background = 'rgba(0, 0, 0, 0.85)';
        });
        
        // ÿØ⁄©ŸÖŸá‚ÄåŸáÿß
        document.getElementById('toggle-debug').addEventListener('click', () => {
            debugMode = !debugMode;
            debugInfo.style.display = debugMode ? 'block' : 'none';
            if (debugMode) {
                debugInfo.innerHTML = debugLog.slice(-10).join('<br>');
            }
            log('üêõ Debug mode: ' + debugMode);
        });
        
        document.getElementById('reset-btn').addEventListener('click', () => {
            if (confirm('ÿ±€åÿ≥ÿ™ ⁄©ŸÜ€åŸÖÿü')) location.reload();
        });
        
        document.getElementById('info-btn').addEventListener('click', () => {
            alert('üì± ÿ±ÿßŸáŸÜŸÖÿß:\n\n' +
                  '1. ÿØŸàÿ±ÿ®€åŸÜ ÿ±ÿß ÿ±Ÿà€å ÿ™ÿµŸà€åÿ± ŸáÿØŸÅ ŸÜ⁄ØŸá ÿØÿßÿ±€åÿØ\n\n' +
                  '2. €å⁄© ŸÖ⁄©ÿπÿ® ŸÇÿ±ŸÖÿ≤ Ÿà ŸÖÿ™ŸÜ ÿ≥ÿ®ÿ≤ ÿ®ÿß€åÿØ ÿ®ÿ®€åŸÜ€åÿØ\n\n' +
                  '3. ÿß⁄Øÿ± ŸÖ⁄©ÿπÿ® ÿ±ÿß ÿØ€åÿØ€åÿØ €åÿπŸÜ€å AR ⁄©ÿßÿ± ŸÖ€å‚Äå⁄©ŸÜÿØ\n\n' +
                  '4. ÿß⁄Øÿ± ŸÖÿØŸÑ ÿßÿµŸÑ€å ŸÜŸÖÿß€åÿ¥ ŸÜÿØÿßÿØÿå ŸÖÿ¥⁄©ŸÑ ÿßÿ≤ ŸÅÿß€åŸÑ GLB ÿßÿ≥ÿ™\n\n' +
                  'üêõ ÿØ⁄©ŸÖŸá debug ÿ±ÿß ÿ®ÿ≤ŸÜ€åÿØ ÿ®ÿ±ÿß€å ŸÖÿ¥ÿßŸáÿØŸá ŸÑÿß⁄Ø‚ÄåŸáÿß');
        });
        
        // ÿ≤ŸàŸÖ
        let initialDistance = 0;
        let currentScale = 1;
        
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2 && targetFound && model) {
                initialDistance = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
            }
        });
        
        document.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2 && targetFound && model && initialDistance > 0) {
                e.preventDefault();
                const currentDistance = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                const scaleDelta = (currentDistance - initialDistance) * 0.002;
                currentScale = Math.max(0.3, Math.min(5, currentScale + scaleDelta));
                model.setAttribute('scale', `${currentScale} ${currentScale} ${currentScale}`);
                log(`Scale changed to: ${currentScale.toFixed(2)}`);
                initialDistance = currentDistance;
            }
        }, { passive: false });
        
        log('‚úÖ All event listeners registered');
    </script>
</body>
</html>
